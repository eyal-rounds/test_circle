test:
  pre:
    - env
    - cat ~/.rounds_cache/build_count
  post:

  override:
    - ./gradlew assembleRelease
    - cp -r app/build/outputs/* $CIRCLE_ARTIFACTS
    - ls $CIRCLE_ARTIFACTS/apk/*release*.apk

dependencies:
  pre:
    - if [[ ! -d ~/.rounds_cache/ ]] ; then mkdir -p ~/.rounds_cache/; fi;
    - curr_ver=$(cat app/build.gradle |grep versionName|tr -d ' \t'|sed -e 's/ *versionName *\"\(.*\)\"/\1/g')
    - if [[ ! -f ~/.rounds_cache/version_name ]] ; then echo $curr_ver > ~/.rounds_cache/version_name; fi;
    - cached_ver=$(cat ~/.rounds_cache/version_name|tr -d ' \t')
    - if [[ "$ver" != "$cached_ver" ]] ; then VERSION_CHANGED=true ;echo $curr_ver > ~/.rounds_cache/version_name; fi;
    - if [[ ! -f ~/.rounds_cache/build_count ]] ; then echo 0 >  ~/.rounds_cache/build_count; fi;
    - count=$(cat ~/.rounds_cache/build_count) && echo $((count+1))> ~/.rounds_cache/build_count
  cache_directories:
    - ~/.rounds_cache/
deployment:
  production:
    branch: master
    commands:
      - file=$(ls $CIRCLE_ARTIFACTS/apk/*release*.apk|grep -vi unaligned)
      - aws s3 cp $file s3://rounds-android-develop/app-release_${CIRCLE_SHA1}.apk
  staging:
    branch: develop
    commands:
      - echo deploy develop